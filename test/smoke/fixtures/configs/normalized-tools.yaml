# yaml-language-server: $schema=https://promptfoo.dev/config-schema.json
description: 'Smoke test - normalized tool format with cross-provider reuse'

providers:
  # Test normalized tools with auto mode
  - id: 'exec:node ../scripts/echo-config.js'
    label: 'Auto tool choice mode'
    config:
      tools: &tools
        - normalized: true
          name: get_weather
          description: Get current weather for a location
          parameters:
            type: object
            properties:
              location:
                type: string
                description: City name
              unit:
                type: string
                enum: [celsius, fahrenheit]
            required:
              - location
        - normalized: true
          name: search_web
          description: Search the web for information
          parameters:
            type: object
            properties:
              query:
                type: string
            required:
              - query
      tool_choice:
        mode: auto

  # Test tool reuse with YAML alias and required mode
  - id: 'exec:node ../scripts/echo-config.js'
    label: 'Required tool choice mode'
    config:
      tools: *tools
      tool_choice:
        mode: required

  # Test specific tool choice mode
  - id: 'exec:node ../scripts/echo-config.js'
    label: 'Specific tool choice mode'
    config:
      tools: *tools
      tool_choice:
        mode: tool
        toolName: get_weather

prompts:
  - 'What is the weather in {{location}}?'

tests:
  - vars:
      location: San Francisco
    assert:
      # Verify the prompt is included
      - type: contains
        value: San Francisco
      # Verify tools array is present with correct structure
      - type: javascript
        value: |
          const parsed = JSON.parse(output);
          return Array.isArray(parsed.tools) && parsed.tools.length === 2;
      # Verify first tool has normalized format fields
      - type: javascript
        value: |
          const parsed = JSON.parse(output);
          const tool = parsed.tools[0];
          return tool.normalized === true && tool.name === 'get_weather' && tool.parameters?.type === 'object';
      # Verify tool_choice is present with mode
      - type: javascript
        value: |
          const parsed = JSON.parse(output);
          return parsed.tool_choice && typeof parsed.tool_choice.mode === 'string';

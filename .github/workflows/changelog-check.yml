name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-changelog:
    name: Check Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changelog update
        id: check
        env:
          HAS_NO_CHANGELOG_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'no-changelog') }}
          HAS_DEPENDENCIES_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          # Check if CHANGELOG.md was modified
          git fetch origin "$BASE_REF"
          CHANGELOG_MODIFIED=$(git diff --name-only origin/"$BASE_REF"...HEAD | grep -c "^CHANGELOG.md$" || true)

          if [ "$CHANGELOG_MODIFIED" -gt 0 ]; then
            echo "✅ CHANGELOG.md has been updated"
            exit 0
          fi

          # Check if PR has no-changelog label
          if [ "$HAS_NO_CHANGELOG_LABEL" = "true" ]; then
            echo "✅ PR has 'no-changelog' label - bypassing check"
            exit 0
          fi

          # Check if PR has dependencies label
          if [ "$HAS_DEPENDENCIES_LABEL" = "true" ]; then
            echo "✅ PR has 'dependencies' label - bypassing check"
            exit 0
          fi

          # All PRs must update the changelog
          echo "❌ Changelog update required"
          echo ""
          echo "ALL PRs must update CHANGELOG.md under the 'Unreleased' section."
          echo ""
          echo "This ensures complete traceability of all changes to the codebase."
          echo ""
          echo "To bypass this check, add one of these labels:"
          echo "  - 'no-changelog' (exceptional cases only)"
          echo "  - 'dependencies' (automated dependency updates)"
          echo ""
          echo "Include ALL changes:"
          echo "  - Feature additions (feat:)"
          echo "  - Bug fixes (fix:)"
          echo "  - Dependency updates (chore(deps):)"
          echo "  - Test changes (test:)"
          echo "  - CI/CD changes (ci:, build:)"
          echo "  - Documentation updates (docs:)"
          echo "  - Code refactors (refactor:)"
          echo "  - Style changes (style:)"
          echo "  - All other changes (chore:)"
          exit 1

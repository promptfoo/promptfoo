name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths-ignore:
      - 'site/**'
      - '.vscode/**'
      - '.cursor/**'
      - '.devcontainer/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - 'SECURITY.md'
      - 'AGENTS.md'
      - 'CLAUDE.md'
      - 'LICENSE'
      - '.**ignore'
      - '.prettierrc*'
      - '.rubocop.yml'
      - '.ruff.toml'
      - '.coderabbit.yaml'

jobs:
  check-changelog:
    name: Check Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check changelog update
        id: check
        env:
          HAS_NO_CHANGELOG_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'no-changelog') }}
          HAS_DEPENDENCIES_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Check if CHANGELOG.md was modified
          git fetch origin "$BASE_REF"
          CHANGELOG_MODIFIED=$(git diff --name-only origin/"$BASE_REF"...HEAD | grep -c "^CHANGELOG.md$" || true)

          if [ "$CHANGELOG_MODIFIED" -gt 0 ]; then
            echo "CHANGELOG.md has been updated"

            # Additional validation for non-version-bump PRs
            if [[ "$BRANCH_NAME" != chore/bump-version-* ]]; then
              # Get the diff of CHANGELOG.md
              DIFF=$(git diff origin/"$BASE_REF"...HEAD -- CHANGELOG.md)

              # Extract added content lines (entries starting with "- ")
              ADDED_ENTRIES=$(echo "$DIFF" | grep -E '^\+- ' || true)

              if [ -n "$ADDED_ENTRIES" ]; then
                # Rule 1: Check for PR number requirement
                # Every entry line must contain (#\d+) format
                MISSING_PR_NUM=$(echo "$ADDED_ENTRIES" | grep -v -E '\(#[0-9]+\)' || true)

                if [ -n "$MISSING_PR_NUM" ]; then
                  echo "Changelog entry missing PR number"
                  echo ""
                  echo "Every changelog entry must include a PR number in (#1234) format."
                  echo ""
                  echo "Expected format: - feat(scope): description (#$PR_NUMBER)"
                  echo ""
                  echo "Entries missing PR numbers:"
                  # shellcheck disable=SC2001
                  echo "$MISSING_PR_NUM" | sed 's/^+/  /'
                  exit 1
                fi

                # Also check for commit hashes (common mistake)
                HAS_COMMIT_HASH=$(echo "$ADDED_ENTRIES" | grep -E '\([a-f0-9]{7,40}\)' | grep -v '#' || true)
                if [ -n "$HAS_COMMIT_HASH" ]; then
                  echo "Commit hash detected instead of PR number"
                  echo ""
                  echo "Use PR numbers (#1234) instead of commit hashes (abc1234)."
                  echo ""
                  echo "Entries with commit hashes:"
                  # shellcheck disable=SC2001
                  echo "$HAS_COMMIT_HASH" | sed 's/^+/  /'
                  exit 1
                fi
              fi

              # Rule 2: Check entries are in Unreleased section
              # Parse the actual file to find where additions land

              # Find the line number where Unreleased section ends (next version header)
              UNRELEASED_END=$(grep -n -E '## \[[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md | head -1 | cut -d: -f1)

              if [ -z "$UNRELEASED_END" ]; then
                # No versioned sections yet, all content is effectively unreleased
                UNRELEASED_END=999999
              fi

              # Check each added line to see if it's in a versioned section
              # Use git diff with line numbers to track positions
              ADDITIONS_IN_VERSIONED=$(git diff origin/"$BASE_REF"...HEAD -- CHANGELOG.md | \
                gawk -v unreleased_end="$UNRELEASED_END" '
                  /^@@/ {
                    # Parse hunk header: @@ -old_start,old_count +new_start,new_count @@
                    match($0, /\+([0-9]+)/, arr)
                    current_line = arr[1] - 1
                    next
                  }
                  /^-/ { next }  # Skip removed lines
                  /^\+/ {
                    current_line++
                    # Check if this is a content line (starts with +- )
                    if (/^\+- / && current_line >= unreleased_end) {
                      print "Line " current_line ": " substr($0, 2)
                    }
                    next
                  }
                  { current_line++ }  # Context lines
                ')

              if [ -n "$ADDITIONS_IN_VERSIONED" ]; then
                echo "Changelog entries must be in the Unreleased section"
                echo ""
                echo "The following entries were added to versioned sections:"
                echo "$ADDITIONS_IN_VERSIONED"
                echo ""
                echo "Add your entries under '## [Unreleased]', not in versioned sections."
                echo "Versioned sections are only updated during release."
                exit 1
              fi

              echo "Changelog validation passed"
            else
              echo "Version bump PR - skipping content validation"
            fi

            exit 0
          fi

          # Check if PR has no-changelog label
          if [ "$HAS_NO_CHANGELOG_LABEL" = "true" ]; then
            echo "PR has 'no-changelog' label - bypassing check"
            exit 0
          fi

          # Check if PR has dependencies label
          if [ "$HAS_DEPENDENCIES_LABEL" = "true" ]; then
            echo "PR has 'dependencies' label - bypassing check"
            exit 0
          fi

          # PRs that modify non-ignored paths must update the changelog
          echo "Changelog update required"
          echo ""
          echo "PRs that modify source code must update CHANGELOG.md under the 'Unreleased' section."
          echo ""
          echo "This ensures complete traceability of all changes to the codebase."
          echo ""
          echo "To bypass this check, add one of these labels:"
          echo "  - 'no-changelog' (exceptional cases only)"
          echo "  - 'dependencies' (automated dependency updates)"
          exit 1

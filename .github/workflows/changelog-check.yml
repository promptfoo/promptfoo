name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-changelog:
    name: Check Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check changelog update
        id: check
        env:
          HAS_NO_CHANGELOG_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'no-changelog') }}
          HAS_DEPENDENCIES_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          # Check if CHANGELOG.md was modified
          git fetch origin "$BASE_REF"
          CHANGELOG_MODIFIED=$(git diff --name-only origin/"$BASE_REF"...HEAD | grep -c "^CHANGELOG.md$" || true)

          if [ "$CHANGELOG_MODIFIED" -gt 0 ]; then
            echo "✅ CHANGELOG.md has been updated"
            exit 0
          fi

          # Check if PR has no-changelog label
          if [ "$HAS_NO_CHANGELOG_LABEL" = "true" ]; then
            echo "✅ PR has 'no-changelog' label - bypassing check"
            exit 0
          fi

          # Check if PR has dependencies label
          if [ "$HAS_DEPENDENCIES_LABEL" = "true" ]; then
            echo "✅ PR has 'dependencies' label - bypassing check"
            exit 0
          fi

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/"$BASE_REF"...HEAD)

          # Define patterns for non-user-facing files that don't require changelog
          # These are documentation, dev environment configs, and other non-code changes
          EXCLUDED_PATTERNS=(
            "^site/"                    # Documentation website
            "^\.vscode/"                # VSCode config
            "^\.cursor/"                # Cursor IDE config
            "^\.devcontainer/"          # Dev container config
            "^README\.md$"              # Root README
            "^CONTRIBUTING\.md$"        # Contributing guide
            "^SECURITY\.md$"            # Security policy
            "^AGENTS\.md$"              # Agents documentation
            "^CLAUDE\.md$"              # Claude instructions
            "^LICENSE$"                 # License file
            "^\..*ignore$"              # Ignore files (.gitignore, .dockerignore, etc)
            "^\.prettierrc"             # Prettier config
            "^\.rubocop\.yml$"          # Rubocop config
            "^\.ruff\.toml$"            # Ruff config
            "^\.coderabbit\.yaml$"      # CodeRabbit config
          )

          # Filter changed files to find user-facing changes
          USER_FACING_CHANGES=""
          while IFS= read -r file; do
            EXCLUDED=false
            for pattern in "${EXCLUDED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                EXCLUDED=true
                break
              fi
            done

            if [ "$EXCLUDED" = false ]; then
              USER_FACING_CHANGES="$USER_FACING_CHANGES$file"$'\n'
            fi
          done <<< "$CHANGED_FILES"

          # If no user-facing files were changed, skip changelog requirement
          if [ -z "$(echo "$USER_FACING_CHANGES" | tr -d '[:space:]')" ]; then
            echo "✅ Only non-user-facing files changed (docs, dev configs) - bypassing changelog check"
            echo ""
            echo "Changed files (all excluded from changelog requirement):"
            echo "$CHANGED_FILES"
            exit 0
          fi

          # User-facing changes require changelog update
          echo "❌ Changelog update required"
          echo ""
          echo "This PR modifies user-facing code and must update CHANGELOG.md under the 'Unreleased' section."
          echo ""
          echo "User-facing files changed:"
          echo "$USER_FACING_CHANGES"
          echo ""
          echo "To bypass this check, add one of these labels:"
          echo "  - 'no-changelog' (exceptional cases only)"
          echo "  - 'dependencies' (automated dependency updates)"
          echo ""
          echo "Note: Changes to documentation (site/), dev configs (.vscode/, .cursor/, etc.),"
          echo "and root markdown files (README.md, CONTRIBUTING.md, etc.) don't require changelog updates."
          exit 1

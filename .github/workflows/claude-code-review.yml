name: Claude Code Review

on:
  pull_request_target:
    types: [opened, ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip for bot PRs and fork PRs due to OIDC token limitations in pull_request_target
    # Fork PRs fail because the actor in OIDC context is the fork contributor (read-only)
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.user.type != 'Bot' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0 # Need full history for incremental diffs
          persist-credentials: false

      - name: Fetch PR head for diff comparison
        run: git fetch origin "${{ github.event.pull_request.head.sha }}"

      - name: Determine review scope
        id: review_scope
        run: |
          # Validate SHA format (40 hex chars, not null SHA) and verify it exists
          is_valid_sha() {
            [[ "$1" =~ ^[0-9a-f]{40}$ ]] && \
            [[ "$1" != "0000000000000000000000000000000000000000" ]] && \
            git rev-parse --verify "$1^{commit}" >/dev/null 2>&1
          }

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.event.after }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # For synchronize events with valid SHAs, do incremental review
          if [ "${{ github.event.action }}" = "synchronize" ] && is_valid_sha "$BEFORE_SHA" && is_valid_sha "$AFTER_SHA"; then
            {
              echo "scope=incremental"
              echo "base_sha=$BEFORE_SHA"
              echo "head_sha=$AFTER_SHA"
            } >> "$GITHUB_OUTPUT"
          else
            # For opened/ready_for_review or invalid SHAs (force push), review entire PR
            {
              echo "scope=full"
              echo "base_sha=$BASE_SHA"
              echo "head_sha=$HEAD_SHA"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are a senior security engineer reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            **PR:** ${{ github.event.pull_request.title }}
            **Author:** ${{ github.event.pull_request.user.login }}
            **Review Scope:** ${{ steps.review_scope.outputs.scope }}

            This is promptfoo, an open-source LLM evaluation framework and AI agent security testing tool. Security review is critical.

            ## Instructions

            1. Run `git diff ${{ steps.review_scope.outputs.base_sha }}..${{ steps.review_scope.outputs.head_sha }}` to see the changes
            2. For incremental reviews, run `gh pr view ${{ github.event.pull_request.number }} --comments` to see previous review feedback
            3. **IMPORTANT:** Only review the changes shown in this diff - do not re-review previously reviewed code
            4. **IMPORTANT:** Do not re-report issues already mentioned in previous reviews unless they appear in new code
            5. Read AGENTS.md for repository conventions
            6. Review for the issues below, focusing on **critical problems only**

            ## Review Focus (Priority Order)

            **üî¥ Security (Critical)**
            - Injection vulnerabilities (command, SQL, XSS, prompt injection)
            - Unsafe handling of user input or adversarial test content
            - Credential/secret exposure, insecure data handling
            - SSRF, path traversal, unsafe deserialization

            **üü† Correctness**
            - Logic errors, incorrect behavior, unhandled edge cases
            - Missing null/undefined checks, race conditions
            - Breaking changes to public APIs

            **üü° Testing**
            - Missing tests for new functionality or bug fixes
            - Tests that don't actually verify the behavior
            - Missing mock cleanup (causes test pollution)

            ## Output Format

            Use this exact structure for your comment:

            ```markdown
            ## Security Review [STATUS]

            [One-line summary: "No critical issues found" or "X issues require attention"]

            ### üî¥ Critical Issues
            [List each critical/security issue - ALWAYS show this section if issues exist]
            - **file:line** - Description. **Fix:** suggestion

            ### üü† Correctness Issues
            [List each correctness issue - show if any exist]
            - **file:line** - Description. **Fix:** suggestion

            <details>
            <summary>üü° Minor Observations (N items)</summary>

            [Low-severity items, suggestions, and non-blocking feedback go here]
            - **file:line** - Observation
            - **file:line** - Observation

            </details>
            ```

            **Format rules:**
            - STATUS: Use ‚úÖ if no critical/correctness issues, ‚ö†Ô∏è if issues found
            - Critical and correctness issues are NEVER collapsed - they must be visible
            - Minor observations (testing suggestions, style notes, non-blocking items) go in collapsible section
            - One line per issue: `**file:line** - Description. **Fix:** suggestion`
            - Omit empty sections entirely (don't show "### üî¥ Critical Issues" with "None")
            - If truly no issues at all: Just post "## Security Review ‚úÖ\n\nNo issues found."

            **For incremental reviews:**
            - Add "üîÑ Incremental Review" before "Security Review" in the header
            - Only report issues in the new changes, not previously reviewed code
            - If no new issues: "## üîÑ Security Review ‚úÖ\n\nNo issues in new changes."

            ## Skip These (Biome/CI catches them)
            - Formatting, import order, naming conventions
            - Minor style preferences

            ## PR Convention Check
            If this PR touches `src/redteam/`, verify the title uses `(redteam)` scope per THE REDTEAM RULE.

            Post your review as a single comment using `gh pr comment ${{ github.event.pull_request.number }}`.
          claude_args: '--max-turns 30 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git diff:*),Bash(git show:*)"'

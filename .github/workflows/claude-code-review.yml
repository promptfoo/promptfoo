name: Claude Code Review

on:
  pull_request_target:
    types: [opened, ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip for bot PRs and fork PRs due to OIDC token limitations in pull_request_target
    # Fork PRs fail because the actor in OIDC context is the fork contributor (read-only)
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.user.type != 'Bot' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Pass event data as env vars to avoid shell injection via ${{ }} interpolation
    env:
      EVENT_ACTION: ${{ github.event.action }}
      EVENT_BEFORE: ${{ github.event.before }}
      EVENT_AFTER: ${{ github.event.after }}
      PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
      PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      REPOSITORY: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0 # Need full history for incremental diffs
          persist-credentials: false

      - name: Fetch PR head for diff comparison
        run: |
          # Validate SHA format before using in git command
          if [[ ! "$PR_HEAD_SHA" =~ ^[0-9a-f]{40}$ ]]; then
            echo "::error::Invalid PR head SHA format"
            exit 1
          fi
          git fetch origin "$PR_HEAD_SHA"

          # Verify the fetch succeeded by checking the SHA exists
          if ! git rev-parse --verify "$PR_HEAD_SHA^{commit}" >/dev/null 2>&1; then
            echo "::error::Failed to fetch PR head SHA"
            exit 1
          fi

      - name: Determine review scope
        id: review_scope
        run: |
          # Validate SHA format (40 hex chars, not null SHA) and verify it exists
          is_valid_sha() {
            [[ "$1" =~ ^[0-9a-f]{40}$ ]] && \
            [[ "$1" != "0000000000000000000000000000000000000000" ]] && \
            git rev-parse --verify "$1^{commit}" >/dev/null 2>&1
          }

          # Check if a commit is a merge commit (has 2+ parents)
          # Used to detect "merge main into branch" which should trigger full review
          is_merge_commit() {
            git rev-parse --verify "$1^2" >/dev/null 2>&1
          }

          # For synchronize events with valid SHAs and no merge commits, do incremental review
          # Merge commits (e.g., merging main into branch) trigger full review to avoid
          # reviewing main branch changes that aren't part of this PR
          if [ "$EVENT_ACTION" = "synchronize" ] && \
             is_valid_sha "$EVENT_BEFORE" && \
             is_valid_sha "$EVENT_AFTER" && \
             ! is_merge_commit "$EVENT_AFTER"; then
            {
              echo "scope=incremental"
              echo "base_sha=$EVENT_BEFORE"
              echo "head_sha=$EVENT_AFTER"
            } >> "$GITHUB_OUTPUT"
          else
            # Full review for: opened, ready_for_review, force push, or merge commits
            {
              echo "scope=full"
              echo "base_sha=$PR_BASE_SHA"
              echo "head_sha=$PR_HEAD_SHA"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare review prompt
        id: prompt
        run: |
          # Read the prompt template and substitute variables
          PROMPT=$(cat .github/prompts/claude-code-review.md)
          PROMPT="${PROMPT//\{\{PR_NUMBER\}\}/$PR_NUMBER}"
          PROMPT="${PROMPT//\{\{REPOSITORY\}\}/$REPOSITORY}"
          PROMPT="${PROMPT//\{\{PR_TITLE\}\}/$PR_TITLE}"
          PROMPT="${PROMPT//\{\{PR_AUTHOR\}\}/$PR_AUTHOR}"
          PROMPT="${PROMPT//\{\{REVIEW_SCOPE\}\}/${{ steps.review_scope.outputs.scope }}}"
          PROMPT="${PROMPT//\{\{BASE_SHA\}\}/${{ steps.review_scope.outputs.base_sha }}}"
          PROMPT="${PROMPT//\{\{HEAD_SHA\}\}/${{ steps.review_scope.outputs.head_sha }}}"

          # Write to env file for multiline output
          {
            echo "REVIEW_PROMPT<<PROMPT_EOF"
            echo "$PROMPT"
            echo "PROMPT_EOF"
          } >> "$GITHUB_ENV"

          # Log for debugging
          echo "Review scope: ${{ steps.review_scope.outputs.scope }}"
          echo "Base SHA: ${{ steps.review_scope.outputs.base_sha }}"
          echo "Head SHA: ${{ steps.review_scope.outputs.head_sha }}"

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ env.REVIEW_PROMPT }}
          claude_args: '--max-turns 30 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git diff:*),Bash(git show:*),Bash(gh api:*)"'

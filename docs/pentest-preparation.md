# Promptfoo Pentest Preparation Guide

## Executive Summary

**Promptfoo is a LOCAL CLI tool** designed to run on `localhost` with **trusted users**. The server is never intended to be exposed to the internet. This fundamentally changes the threat model - most external-facing web application security concerns don't apply.

This document prioritizes findings based on this context, distinguishing between:

- **Relevant**: Issues that matter even for local trusted-user scenarios
- **Conditional**: Issues that only matter if the tool is misused (exposed to network)
- **Not Applicable**: Standard web security items that don't apply to this architecture

---

## Threat Model

| Assumption                      | Implication                                     |
| ------------------------------- | ----------------------------------------------- |
| Server runs on `localhost` only | Network-based attacks require local presence    |
| All users are trusted           | AuthN/AuthZ not required by design              |
| Single-user tool                | No multi-tenancy, no user isolation needed      |
| Users have local shell access   | Command execution is feature, not vulnerability |
| Users have filesystem access    | Path traversal grants no additional access      |

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                     User's Machine                          │
│  ┌───────────┐     ┌──────────────────────────────────┐    │
│  │  Browser  │────▶│  Express Server (localhost:3000) │    │
│  │ (trusted) │     │  ├─ REST API routes              │    │
│  └───────────┘     │  ├─ Socket.IO (real-time)        │    │
│                    │  └─ Static file server           │    │
│                    └──────────────────────────────────┘    │
│                              │                              │
│                    ┌─────────┴─────────┐                   │
│                    ▼                   ▼                    │
│            ┌──────────────┐    ┌─────────────┐             │
│            │ SQLite DB    │    │ Child Procs │             │
│            │ ~/.promptfoo │    │ (by design) │             │
│            └──────────────┘    └─────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

**Key Files:**

- `src/server/server.ts` - Express app setup, middleware configuration
- `src/server/routes/*.ts` - API endpoint handlers
- `src/providers/scriptCompletion.ts` - Script/command execution provider
- `src/server/routes/modelAudit.ts` - External process spawning

---

## Priority 1: RELEVANT (Even for Local Trusted Use)

### 1.1 Supply Chain Security

**Status**: Critical to verify

The tool processes LLM outputs, runs external commands, and parses untrusted data. Dependency vulnerabilities can have significant impact.

**Audit Items:**

- [x] Run `npm audit` - **0 vulnerabilities** (checked 2025-12)
- [x] Verify lockfile integrity - **passed** `lockfile-lint` (all npm, all HTTPS)
- [ ] Verify no known vulnerable versions of critical deps:
  - `express` (current: check package.json)
  - `socket.io`
  - `better-sqlite3`
  - `nunjucks` (template engine)
  - `zod` (validation)
- [ ] Check for malicious packages (typosquatting)
- [ ] Secret scanning in repository history

**Last Audit Results:**

```
npm audit: 0 vulnerabilities (669 prod deps, 2163 dev deps)
lockfile-lint: No issues detected (all npm registry, all HTTPS)
```

**Commands:**

```bash
npm audit
npm outdated
npx lockfile-lint --path package-lock.json --allowed-hosts npm --validate-https
```

### 1.2 Template Injection (Nunjucks)

**Location**: `src/util/templates.ts`

**Finding**: Nunjucks configured with `autoescape: false` and exposes `process.env`:

```typescript
// src/util/templates.ts:26-40
nunjucks.configure({ autoescape: false, ... })
// Line 40: Adds process.env to template globals
```

**Risk**: Users craft prompts that are rendered as Nunjucks templates. If malicious content reaches template rendering, it could:

- Access environment variables (API keys, secrets)
- Execute template expressions

**Audit Items:**

- [ ] Map all paths where user input reaches `nunjucks.renderString()`
- [ ] Verify `PROMPTFOO_DISABLE_TEMPLATE_ENV_VARS` is documented
- [ ] Check for SSTI patterns in template rendering paths

**Mitigating Context**: Users are trusted and have shell access anyway, but API keys in env could be exfiltrated through template injection in a less obvious way.

### 1.3 JSON Parsing of Untrusted Output

**Locations**: Multiple files parse JSON from external sources

| File                  | Line | Source               | Risk                                     |
| --------------------- | ---- | -------------------- | ---------------------------------------- |
| `scriptCompletion.ts` | 84   | Cached script output | Prototype pollution if cache compromised |
| `modelAudit.ts`       | 349  | External CLI stdout  | JSON bomb, malformed JSON crashes        |
| Various providers     | -    | LLM API responses    | Malformed responses                      |

**Audit Items:**

- [ ] Verify `JSON.parse()` calls are wrapped in try-catch
- [ ] Check for prototype pollution vectors in parsed objects
- [ ] Verify size limits on parsed content

### 1.4 Denial of Service Vectors

**100MB Request Limit**: `src/server/server.ts:54`

```typescript
const REQUEST_SIZE_LIMIT = '100mb';
app.use(express.json({ limit: REQUEST_SIZE_LIMIT }));
```

**Risk**: Even trusted users could accidentally trigger resource exhaustion.

**Audit Items:**

- [ ] Document intentional choice of 100MB limit (needed for large eval results?)
- [ ] Check for missing timeouts on:
  - Database operations
  - External HTTP requests
  - Child process execution
- [ ] Verify graceful handling of large payloads

**Known Timeouts:**

- `modelAudit.ts`: 3600s (1 hour) default timeout - intentional for large scans

### 1.5 Error Information Disclosure

**Pattern**: Error responses include internal details

```typescript
// modelAudit.ts:206-213
safeRespond(500, {
  error: errorMessage,
  originalError: error.message,
  debug: {
    command: 'modelaudit',
    args: args,
    paths: resolvedPaths,
    cwd: process.cwd(),
  },
});
```

**Risk**: Leaks internal paths, command arguments. Less critical for local use but could aid attacks if exposed.

**Audit Items:**

- [ ] Inventory all error responses that include `debug` info
- [ ] Consider environment-based verbosity (verbose in dev, minimal in prod)

---

## Priority 2: CONDITIONAL (Only if Exposed to Network)

These items are **NOT vulnerabilities in the intended use case** but become critical if someone incorrectly exposes the server to a network.

### 2.1 No Authentication

**Finding**: All endpoints are unauthenticated

**Location**: `src/server/server.ts` - no auth middleware

**Intended**: Yes - this is a local CLI tool

**Risk if Exposed**: Complete data access, eval manipulation, command execution

**Audit Items:**

- [ ] Document this is intentional for local use
- [ ] Add warning in docs about network exposure
- [ ] Consider optional auth flag for advanced users who want network access

### 2.2 CORS Allows All Origins

**Location**: `src/server/server.ts:90`

```typescript
app.use(cors()); // Defaults to Access-Control-Allow-Origin: *
```

**And Socket.IO**: `src/server/server.ts:284-287`

```typescript
const io = new SocketIOServer(httpServer, {
  cors: { origin: '*' },
});
```

**Intended**: Yes - allows the Vite dev server on a different port to access the API

**Risk if Exposed**: Any website could make requests to the API

**Audit Items:**

- [ ] Document this is intentional
- [ ] Consider restricting to `localhost` origins only

### 2.3 Static Files Serve Dotfiles

**Location**: `src/server/server.ts:268`

```typescript
app.use(express.static(staticDir, { dotfiles: 'allow' }));
```

**Context**: `staticDir` is the built web app directory (`dist/app`), NOT the user's working directory

**Risk**: Low - only serves the bundled frontend assets, not arbitrary directories

**Audit Items:**

- [ ] Verify `staticDir` cannot be manipulated
- [ ] Confirm no sensitive dotfiles in the build output

### 2.4 Command Execution via API

**Locations**:

- `POST /api/model-audit/scan` - spawns `modelaudit` CLI
- Script completion providers - executes user-specified scripts

**Files**:

- `src/server/routes/modelAudit.ts:152` - `spawn('modelaudit', args)`
- `src/providers/scriptCompletion.ts:105` - `execFile(command, scriptArgs, options)`

**Intended**: Yes - core functionality

**Security Controls Present**:

- `modelAudit.ts`: Path existence validation, home directory expansion, absolute path resolution
- `scriptCompletion.ts`: Uses `execFile()` (not `exec()`), passes args as array (prevents shell injection)

**Audit Items:**

- [ ] Verify `execFile()` is used consistently (not `exec()`)
- [ ] Verify arguments passed as arrays, not string concatenation
- [ ] Document that command execution is a feature, not a bug

### 2.5 External HTTP Requests (SSRF Vectors)

**Locations where user input influences HTTP requests**:

| Route                                | Destination         | Control                        |
| ------------------------------------ | ------------------- | ------------------------------ |
| `POST /api/providers/http-generator` | `api.promptfoo.app` | Request/response examples sent |
| `POST /api/redteam/:task`            | Cloud function      | Task parameter forwarded       |
| Provider test endpoints              | User-specified URLs | Direct user control            |

**Intended**: Yes - testing LLM providers requires making HTTP requests to them

**Audit Items:**

- [ ] For cloud endpoints: verify only Promptfoo cloud is called
- [ ] For provider testing: document user-controlled URLs are intentional
- [ ] No SSRF protections needed for local tool where user has curl anyway

---

## Priority 3: NOT APPLICABLE (Given Threat Model)

These are standard web security items that **do not apply** to a local CLI tool with trusted users. Documented here for completeness and to explain why they're not being addressed.

| Item                                        | Why Not Applicable                                   |
| ------------------------------------------- | ---------------------------------------------------- |
| **Authentication hardening**                | No untrusted users; single-user local tool           |
| **Session management**                      | No sessions needed for local use                     |
| **CSRF protection**                         | No cross-site requests from untrusted origins matter |
| **Rate limiting**                           | Single trusted user; no abuse vector                 |
| **User enumeration**                        | No users to enumerate                                |
| **Password policies**                       | No passwords                                         |
| **Multi-tenant isolation**                  | Single tenant by design                              |
| **Authorization/RBAC**                      | All operations permitted for local user              |
| **Account lockout**                         | No accounts                                          |
| **Brute force protection**                  | Nothing to brute force                               |
| **XSS in server responses**                 | Trusted user viewing their own data                  |
| **Clickjacking**                            | Trusted user on localhost                            |
| **Open redirects**                          | No redirect parameters; trusted user                 |
| **HSTS**                                    | HTTP on localhost is fine                            |
| **Security headers (X-Frame-Options, CSP)** | Local trusted browser                                |

---

## Code Audit: Specific Files

### Critical Path: Request → Command Execution

```
Browser Request
    ↓
POST /api/model-audit/scan
    ↓
modelAudit.ts:72-421
    ↓
parseModelAuditArgs() - builds CLI arguments
    ↓
spawn('modelaudit', args) - line 152
    ↓
External process execution
```

**Controls**:

- Path validation: Lines 91-117 (existence check, absolute path conversion)
- Argument parsing: Uses array arguments (safe)
- No shell interpretation (spawn, not exec)

### Critical Path: Script Provider Execution

```
Eval Config
    ↓
provider: "exec:./my-script.sh"
    ↓
ScriptCompletionProvider.callApi()
    ↓
parseScriptParts() - tokenizes command
    ↓
execFile(command, scriptArgs) - line 105
    ↓
External script execution
```

**Controls**:

- Uses `execFile()` not `exec()` (no shell interpretation)
- Arguments passed as array

---

## Endpoint Inventory

### Unauthenticated by Design (All Endpoints)

| Method    | Path                    | Function          | Notes                     |
| --------- | ----------------------- | ----------------- | ------------------------- |
| GET       | `/health`               | Health check      | Exposes version           |
| GET       | `/api/results`          | List evals        | DB read                   |
| GET       | `/api/results/:id`      | Get eval          | DB read                   |
| POST      | `/api/results/share`    | Share eval        | Cloud API call            |
| GET       | `/api/prompts`          | List prompts      | DB read, cached           |
| GET       | `/api/datasets`         | List test cases   | DB read                   |
| POST      | `/api/dataset/generate` | Generate tests    | LLM call                  |
| POST      | `/api/eval/job`         | Start eval        | Background job, LLM calls |
| GET       | `/api/eval/job/:id`     | Poll job          | Job status                |
| POST      | `/api/eval/replay`      | Replay test       | LLM call                  |
| DELETE    | `/api/eval/:id`         | Delete eval       | DB write                  |
| POST      | `/api/providers/test`   | Test provider     | External API call         |
| POST      | `/api/model-audit/scan` | Run scan          | **Process spawn**         |
| POST      | `/api/redteam/run`      | Run red team      | Background job            |
| POST      | `/api/user/login`       | Cloud login       | Cloud API call            |
| WebSocket | `/`                     | Real-time updates | All clients               |

---

## Pentest Scope Recommendations

### In Scope (Recommended Focus)

1. **Dependency vulnerabilities** - run SCA tools
2. **Template injection paths** - test SSTI in Nunjucks templates
3. **JSON parsing robustness** - malformed JSON, JSON bombs
4. **Resource exhaustion** - large payloads, slow requests
5. **Child process handling** - edge cases in command execution
6. **Error handling** - unhandled exceptions, crashes

### Out of Scope (Not Applicable)

1. Authentication/authorization testing (none by design)
2. Session/cookie security (no sessions)
3. CSRF testing (no cross-site context)
4. User isolation testing (single user)
5. Network-based attacks (localhost only)

### Conditional Scope (If Testing Network Exposure Scenario)

If the pentest wants to assess "what if someone exposed this to a network":

1. CORS exploitation from malicious webpage
2. WebSocket hijacking
3. API abuse without authentication
4. Command execution through API

---

## Recommended Fixes (Prioritized)

### Should Fix (Even for Local Use)

| Issue                        | Location          | Recommendation                                    |
| ---------------------------- | ----------------- | ------------------------------------------------- |
| Template autoescape disabled | `templates.ts:26` | Document risk; consider enabling for user content |
| process.env in templates     | `templates.ts:40` | Default to disabled; require explicit opt-in      |
| Verbose error responses      | Multiple          | Add production mode that hides debug info         |
| Missing request timeouts     | `server.ts`       | Add reasonable default timeout                    |

### Consider Fixing (Defense in Depth)

| Issue              | Location        | Recommendation                             |
| ------------------ | --------------- | ------------------------------------------ |
| CORS: \*           | `server.ts:90`  | Restrict to localhost origins              |
| Socket.IO CORS: \* | `server.ts:285` | Restrict to localhost origins              |
| 100MB body limit   | `server.ts:54`  | Consider reducing; document if intentional |

### Won't Fix (By Design)

| Issue             | Reason                            |
| ----------------- | --------------------------------- |
| No authentication | Local CLI tool with trusted users |
| No authorization  | Single-user by design             |
| No rate limiting  | Single trusted user               |
| Command execution | Core feature                      |

---

## Test Accounts & Environment

Not applicable - no authentication system.

**To test:**

```bash
# Start server
npm run dev:server

# Server available at http://localhost:3000
# All endpoints accessible without authentication
```

---

## Known Constraints

- **Do not delete**: `~/.promptfoo/promptfoo.db` (SQLite database)
- **Do not delete**: `~/.cache/promptfoo` (cache directory)
- **Do not test destructive operations** on production data
- **Rate limits**: External LLM providers may rate limit; use test providers

---

## Contact for Critical Findings

[Add appropriate contact information for immediate security escalation]

---

## Appendix: Security-Sensitive Code Paths

### Command Execution (Intentional)

```
src/server/routes/modelAudit.ts:152
  spawn('modelaudit', args)

src/providers/scriptCompletion.ts:105
  execFile(command, scriptArgs, options)

src/prompts/processors/executable.ts:75
  execFile(command, scriptArgs, options)
```

### External HTTP Requests

```
src/server/routes/providers.ts - POST /api/providers/http-generator
  → fetchWithProxy() to api.promptfoo.app

src/server/routes/redteam.ts - POST /api/redteam/:task
  → fetchWithProxy() to cloud function

Various providers - LLM API calls (intentional)
```

### File System Access

```
src/server/routes/modelAudit.ts:30-69
  POST /check-path - validates path existence
  Controls: path.resolve(), fs.existsSync()

src/providers/scriptCompletion.ts:44-52
  getFileHashes() - reads files for caching
  Controls: fs.existsSync() check before read
```

### Template Rendering

```
src/util/templates.ts
  getNunjucksEngine() - configures template engine
  Risk: autoescape: false, process.env exposed
```

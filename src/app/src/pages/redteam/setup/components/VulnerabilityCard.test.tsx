import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import VulnerabilityCard from './VulnerabilityCard';
import type { VulnerabilityFoundEvent } from '@promptfoo/types';

describe('VulnerabilityCard', () => {
  const createVulnerability = (
    overrides: Partial<VulnerabilityFoundEvent> = {},
  ): VulnerabilityFoundEvent => ({
    id: 'test-vuln-1',
    pluginId: 'promptfoo:redteam:sql-injection',
    pluginName: 'SQL Injection',
    severity: 'critical',
    prompt: 'Test prompt with malicious SQL',
    output: 'Model output that reveals vulnerability',
    timestamp: Date.now(),
    testIndex: 0,
    score: 0.85,
    ...overrides,
  });

  it('should render vulnerability plugin name', () => {
    const vulnerability = createVulnerability();
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    expect(screen.getByText('SQL Injection')).toBeInTheDocument();
  });

  it('should display strategy name when present', () => {
    const vulnerability = createVulnerability({
      strategyId: 'jailbreak',
      strategyName: 'Jailbreak',
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    expect(screen.getByText('Jailbreak')).toBeInTheDocument();
  });

  it('should expand to show details when clicked', () => {
    const vulnerability = createVulnerability();
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Initially collapsed - should not show prompt/output
    expect(screen.queryByText('Attack Prompt')).not.toBeVisible();

    // Click to expand
    fireEvent.click(screen.getByText('SQL Injection'));

    // Should now show prompt and output sections
    expect(screen.getByText('Attack Prompt')).toBeVisible();
    expect(screen.getByText('Model Response')).toBeVisible();
  });

  it('should display prompt text when expanded', () => {
    const vulnerability = createVulnerability({
      prompt: 'SELECT * FROM users WHERE id = 1; DROP TABLE users;',
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Expand the card
    fireEvent.click(screen.getByText('SQL Injection'));

    expect(
      screen.getByText('SELECT * FROM users WHERE id = 1; DROP TABLE users;'),
    ).toBeInTheDocument();
  });

  it('should display output text when expanded', () => {
    const vulnerability = createVulnerability({
      output: 'Here is how you can drop a table...',
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Expand the card
    fireEvent.click(screen.getByText('SQL Injection'));

    expect(screen.getByText('Here is how you can drop a table...')).toBeInTheDocument();
  });

  it('should show test index and score when expanded', () => {
    const vulnerability = createVulnerability({
      testIndex: 5,
      score: 0.92,
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Expand the card
    fireEvent.click(screen.getByText('SQL Injection'));

    expect(screen.getByText('Test #6')).toBeInTheDocument();
    expect(screen.getByText('Score: 92%')).toBeInTheDocument();
  });

  it('should handle missing prompt gracefully', () => {
    const vulnerability = createVulnerability({
      prompt: '',
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Expand the card
    fireEvent.click(screen.getByText('SQL Injection'));

    expect(screen.getByText('No prompt available')).toBeInTheDocument();
  });

  it('should handle missing output gracefully', () => {
    const vulnerability = createVulnerability({
      output: '',
    });
    render(<VulnerabilityCard vulnerability={vulnerability} />);

    // Expand the card
    fireEvent.click(screen.getByText('SQL Injection'));

    expect(screen.getByText('No output available')).toBeInTheDocument();
  });

  it('should render different severity colors', () => {
    const severities = ['critical', 'high', 'medium', 'low'] as const;

    for (const severity of severities) {
      const { unmount } = render(
        <VulnerabilityCard
          vulnerability={createVulnerability({ severity, pluginName: `${severity} test` })}
        />,
      );
      expect(screen.getByText(`${severity} test`)).toBeInTheDocument();
      unmount();
    }
  });
});

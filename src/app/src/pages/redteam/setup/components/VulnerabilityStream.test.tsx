import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import VulnerabilityStream from './VulnerabilityStream';
import type { VulnerabilityFoundEvent, VulnerabilitySeverityCounts } from '@promptfoo/types';

describe('VulnerabilityStream', () => {
  const defaultCounts: VulnerabilitySeverityCounts = {
    critical: 0,
    high: 0,
    medium: 0,
    low: 0,
  };

  const createVulnerability = (
    id: string,
    severity: VulnerabilityFoundEvent['severity'] = 'high',
    overrides: Partial<VulnerabilityFoundEvent> = {},
  ): VulnerabilityFoundEvent => ({
    id,
    pluginId: `promptfoo:redteam:${severity}-vuln`,
    pluginName: `${severity.charAt(0).toUpperCase() + severity.slice(1)} Vulnerability`,
    severity,
    prompt: `Test prompt for ${id}`,
    output: `Test output for ${id}`,
    timestamp: Date.now(),
    testIndex: 0,
    score: 0.8,
    ...overrides,
  });

  it('should render header with title', () => {
    render(<VulnerabilityStream vulnerabilities={[]} severityCounts={defaultCounts} />);

    expect(screen.getByText('Vulnerabilities Found')).toBeInTheDocument();
  });

  it('should render severity counters', () => {
    const counts: VulnerabilitySeverityCounts = {
      critical: 2,
      high: 3,
      medium: 5,
      low: 1,
    };

    render(<VulnerabilityStream vulnerabilities={[]} severityCounts={counts} />);

    expect(screen.getByText(/Critical: 2/)).toBeInTheDocument();
    expect(screen.getByText(/High: 3/)).toBeInTheDocument();
    expect(screen.getByText(/Medium: 5/)).toBeInTheDocument();
    expect(screen.getByText(/Low: 1/)).toBeInTheDocument();
  });

  it('should show empty state when no vulnerabilities', () => {
    render(<VulnerabilityStream vulnerabilities={[]} severityCounts={defaultCounts} />);

    expect(
      screen.getByText('Vulnerabilities will appear here as they are discovered'),
    ).toBeInTheDocument();
  });

  it('should render vulnerability cards', () => {
    const vulnerabilities = [
      createVulnerability('vuln-1', 'critical', { pluginName: 'SQL Injection' }),
      createVulnerability('vuln-2', 'high', { pluginName: 'PII Exposure' }),
    ];

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 1, high: 1, medium: 0, low: 0 }}
      />,
    );

    expect(screen.getByText('SQL Injection')).toBeInTheDocument();
    expect(screen.getByText('PII Exposure')).toBeInTheDocument();
  });

  it('should display vulnerability count', () => {
    const vulnerabilities = [
      createVulnerability('vuln-1'),
      createVulnerability('vuln-2'),
      createVulnerability('vuln-3'),
    ];

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 0, high: 3, medium: 0, low: 0 }}
      />,
    );

    expect(screen.getByText('3 vulnerabilities')).toBeInTheDocument();
  });

  it('should show filter menu when filter button is clicked', () => {
    render(<VulnerabilityStream vulnerabilities={[]} severityCounts={defaultCounts} />);

    // Click filter button
    const filterButton = screen.getByRole('button');
    fireEvent.click(filterButton);

    // Menu should appear with filter options
    expect(screen.getByText('All Severities')).toBeInTheDocument();
    expect(screen.getByText('Critical Only')).toBeInTheDocument();
    expect(screen.getByText('High Only')).toBeInTheDocument();
    expect(screen.getByText('Medium Only')).toBeInTheDocument();
    expect(screen.getByText('Low Only')).toBeInTheDocument();
  });

  it('should filter vulnerabilities by severity', () => {
    const vulnerabilities = [
      createVulnerability('vuln-1', 'critical', { pluginName: 'Critical Issue' }),
      createVulnerability('vuln-2', 'high', { pluginName: 'High Issue' }),
      createVulnerability('vuln-3', 'low', { pluginName: 'Low Issue' }),
    ];

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 1, high: 1, medium: 0, low: 1 }}
      />,
    );

    // Initially all should be visible
    expect(screen.getByText('Critical Issue')).toBeInTheDocument();
    expect(screen.getByText('High Issue')).toBeInTheDocument();
    expect(screen.getByText('Low Issue')).toBeInTheDocument();

    // Click filter button and select "Critical Only"
    const filterButton = screen.getAllByRole('button')[0];
    fireEvent.click(filterButton);
    fireEvent.click(screen.getByText('Critical Only'));

    // Only critical should be visible
    expect(screen.getByText('Critical Issue')).toBeInTheDocument();
    expect(screen.queryByText('High Issue')).not.toBeInTheDocument();
    expect(screen.queryByText('Low Issue')).not.toBeInTheDocument();
  });

  it('should show filter chip when filter is active', () => {
    const vulnerabilities = [createVulnerability('vuln-1', 'high')];

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 0, high: 1, medium: 0, low: 0 }}
      />,
    );

    // Apply a filter
    const filterButton = screen.getAllByRole('button')[0];
    fireEvent.click(filterButton);
    fireEvent.click(screen.getByText('High Only'));

    // Filter chip should appear
    expect(screen.getByText('Filtering: high')).toBeInTheDocument();
  });

  it('should clear filter when chip delete is clicked', () => {
    const vulnerabilities = [
      createVulnerability('vuln-1', 'critical', { pluginName: 'Critical Issue' }),
      createVulnerability('vuln-2', 'high', { pluginName: 'High Issue' }),
    ];

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 1, high: 1, medium: 0, low: 0 }}
      />,
    );

    // Apply a filter
    const filterButton = screen.getAllByRole('button')[0];
    fireEvent.click(filterButton);
    fireEvent.click(screen.getByText('Critical Only'));

    // Only critical should be visible
    expect(screen.getByText('Critical Issue')).toBeInTheDocument();
    expect(screen.queryByText('High Issue')).not.toBeInTheDocument();

    // Click the delete button on the filter chip
    const filterChip = screen.getByText('Filtering: critical').closest('.MuiChip-root');
    const deleteButton = filterChip?.querySelector('.MuiChip-deleteIcon');
    if (deleteButton) {
      fireEvent.click(deleteButton);
    }

    // Both should be visible again
    expect(screen.getByText('Critical Issue')).toBeInTheDocument();
    expect(screen.getByText('High Issue')).toBeInTheDocument();
  });

  it('should limit visible vulnerabilities to maxVisible', () => {
    const vulnerabilities = Array.from({ length: 60 }, (_, i) =>
      createVulnerability(`vuln-${i}`, 'high', { pluginName: `Vulnerability ${i}` }),
    );

    render(
      <VulnerabilityStream
        vulnerabilities={vulnerabilities}
        severityCounts={{ critical: 0, high: 60, medium: 0, low: 0 }}
        maxVisible={10}
      />,
    );

    expect(screen.getByText('Showing 10 of 60 vulnerabilities')).toBeInTheDocument();
  });
});

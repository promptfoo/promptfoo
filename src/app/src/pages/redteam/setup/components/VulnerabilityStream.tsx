import { useRef, useEffect, useState, useMemo } from 'react';
import SecurityIcon from '@mui/icons-material/Security';
import FilterListIcon from '@mui/icons-material/FilterList';
import Box from '@mui/material/Box';
import Chip from '@mui/material/Chip';
import Collapse from '@mui/material/Collapse';
import IconButton from '@mui/material/IconButton';
import Menu from '@mui/material/Menu';
import MenuItem from '@mui/material/MenuItem';
import { useTheme, alpha } from '@mui/material/styles';
import type { SxProps, Theme } from '@mui/material/styles';
import Typography from '@mui/material/Typography';
import type {
  VulnerabilityFoundEvent,
  VulnerabilitySeverity,
  VulnerabilitySeverityCounts,
} from '@promptfoo/types';

import SeverityCounters from './SeverityCounters';
import VulnerabilityCard from './VulnerabilityCard';

interface VulnerabilityStreamProps {
  vulnerabilities: VulnerabilityFoundEvent[];
  severityCounts: VulnerabilitySeverityCounts;
  maxVisible?: number;
  sx?: SxProps<Theme>;
}

type SeverityFilter = VulnerabilitySeverity | 'all';

/**
 * Container component for the live vulnerability stream.
 * Shows severity counters at the top and a scrollable list of vulnerability cards.
 */
export default function VulnerabilityStream({
  vulnerabilities,
  severityCounts,
  maxVisible = 50,
  sx = {},
}: VulnerabilityStreamProps) {
  const theme = useTheme();
  const listRef = useRef<HTMLDivElement>(null);
  const [autoScroll, setAutoScroll] = useState(true);
  const [filterAnchorEl, setFilterAnchorEl] = useState<null | HTMLElement>(null);
  const [severityFilter, setSeverityFilter] = useState<SeverityFilter>('all');
  const [newIds, setNewIds] = useState<Set<string>>(new Set());

  // Track newly added vulnerabilities for animation
  useEffect(() => {
    if (vulnerabilities.length > 0) {
      const latestId = vulnerabilities[vulnerabilities.length - 1].id;
      setNewIds((prev) => new Set([...prev, latestId]));

      // Clear the "new" state after animation completes
      const timeout = setTimeout(() => {
        setNewIds((prev) => {
          const next = new Set(prev);
          next.delete(latestId);
          return next;
        });
      }, 500);

      return () => clearTimeout(timeout);
    }
  }, [vulnerabilities.length]);

  // Auto-scroll to bottom when new vulnerabilities arrive
  useEffect(() => {
    if (autoScroll && listRef.current) {
      listRef.current.scrollTop = listRef.current.scrollHeight;
    }
  }, [vulnerabilities.length, autoScroll]);

  // Handle scroll to detect manual scrolling
  const handleScroll = () => {
    if (listRef.current) {
      const { scrollTop, scrollHeight, clientHeight } = listRef.current;
      // If user scrolled up, disable auto-scroll
      // If they scroll to bottom, re-enable it
      const isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
      setAutoScroll(isAtBottom);
    }
  };

  // Filter vulnerabilities by severity
  const filteredVulnerabilities = useMemo(() => {
    let filtered =
      severityFilter === 'all'
        ? vulnerabilities
        : vulnerabilities.filter((v) => v.severity === severityFilter);

    // Limit to maxVisible, showing most recent
    if (filtered.length > maxVisible) {
      filtered = filtered.slice(-maxVisible);
    }

    // Reverse to show newest at top
    return [...filtered].reverse();
  }, [vulnerabilities, severityFilter, maxVisible]);

  const totalCount = vulnerabilities.length;
  const hasVulnerabilities = totalCount > 0;

  return (
    <Box
      sx={{
        display: 'flex',
        flexDirection: 'column',
        height: '100%',
        ...sx,
      }}
    >
      {/* Header with counters */}
      <Box
        sx={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          mb: 2,
          pb: 2,
          borderBottom: `1px solid ${theme.palette.divider}`,
        }}
      >
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <SecurityIcon color="error" />
          <Typography variant="subtitle1" fontWeight={600}>
            Vulnerabilities Found
          </Typography>
        </Box>
        <SeverityCounters counts={severityCounts} />
      </Box>

      {/* Filter bar */}
      <Box
        sx={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          mb: 1,
        }}
      >
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <IconButton
            size="small"
            onClick={(e) => setFilterAnchorEl(e.currentTarget)}
            sx={{ p: 0.5 }}
          >
            <FilterListIcon fontSize="small" />
          </IconButton>
          <Menu
            anchorEl={filterAnchorEl}
            open={Boolean(filterAnchorEl)}
            onClose={() => setFilterAnchorEl(null)}
          >
            <MenuItem
              selected={severityFilter === 'all'}
              onClick={() => {
                setSeverityFilter('all');
                setFilterAnchorEl(null);
              }}
            >
              All Severities
            </MenuItem>
            <MenuItem
              selected={severityFilter === 'critical'}
              onClick={() => {
                setSeverityFilter('critical');
                setFilterAnchorEl(null);
              }}
            >
              Critical Only
            </MenuItem>
            <MenuItem
              selected={severityFilter === 'high'}
              onClick={() => {
                setSeverityFilter('high');
                setFilterAnchorEl(null);
              }}
            >
              High Only
            </MenuItem>
            <MenuItem
              selected={severityFilter === 'medium'}
              onClick={() => {
                setSeverityFilter('medium');
                setFilterAnchorEl(null);
              }}
            >
              Medium Only
            </MenuItem>
            <MenuItem
              selected={severityFilter === 'low'}
              onClick={() => {
                setSeverityFilter('low');
                setFilterAnchorEl(null);
              }}
            >
              Low Only
            </MenuItem>
          </Menu>
          {severityFilter !== 'all' && (
            <Chip
              label={`Filtering: ${severityFilter}`}
              size="small"
              onDelete={() => setSeverityFilter('all')}
              sx={{ textTransform: 'capitalize' }}
            />
          )}
        </Box>
        <Typography variant="caption" color="text.secondary">
          {totalCount > maxVisible
            ? `Showing ${maxVisible} of ${totalCount} vulnerabilities`
            : `${totalCount} vulnerabilities`}
        </Typography>
      </Box>

      {/* Vulnerability list */}
      <Box
        ref={listRef}
        onScroll={handleScroll}
        sx={{
          flex: 1,
          overflowY: 'auto',
          overflowX: 'hidden',
          pr: 1,
          // Scrollbar styling
          '&::-webkit-scrollbar': {
            width: 8,
          },
          '&::-webkit-scrollbar-track': {
            backgroundColor: 'transparent',
          },
          '&::-webkit-scrollbar-thumb': {
            backgroundColor: alpha(theme.palette.text.primary, 0.2),
            borderRadius: 4,
            '&:hover': {
              backgroundColor: alpha(theme.palette.text.primary, 0.3),
            },
          },
        }}
      >
        <Collapse in={hasVulnerabilities}>
          {filteredVulnerabilities.map((vulnerability) => (
            <VulnerabilityCard
              key={vulnerability.id}
              vulnerability={vulnerability}
              isNew={newIds.has(vulnerability.id)}
            />
          ))}
        </Collapse>

        {!hasVulnerabilities && (
          <Box
            sx={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              py: 4,
              color: 'text.secondary',
            }}
          >
            <SecurityIcon sx={{ fontSize: 48, mb: 1, opacity: 0.3 }} />
            <Typography variant="body2" color="text.secondary">
              Vulnerabilities will appear here as they are discovered
            </Typography>
          </Box>
        )}
      </Box>

      {/* Auto-scroll indicator */}
      {!autoScroll && hasVulnerabilities && (
        <Box
          sx={{
            display: 'flex',
            justifyContent: 'center',
            pt: 1,
          }}
        >
          <Chip
            label="New vulnerabilities below"
            size="small"
            color="primary"
            onClick={() => {
              setAutoScroll(true);
              if (listRef.current) {
                listRef.current.scrollTop = listRef.current.scrollHeight;
              }
            }}
            sx={{ cursor: 'pointer' }}
          />
        </Box>
      )}
    </Box>
  );
}

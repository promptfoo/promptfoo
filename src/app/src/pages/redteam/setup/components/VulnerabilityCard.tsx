import { useState } from 'react';
import ErrorIcon from '@mui/icons-material/Error';
import ReportProblemIcon from '@mui/icons-material/ReportProblem';
import WarningIcon from '@mui/icons-material/Warning';
import InfoIcon from '@mui/icons-material/Info';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import ExpandLessIcon from '@mui/icons-material/ExpandLess';
import Box from '@mui/material/Box';
import Card from '@mui/material/Card';
import CardContent from '@mui/material/CardContent';
import Chip from '@mui/material/Chip';
import Collapse from '@mui/material/Collapse';
import IconButton from '@mui/material/IconButton';
import { useTheme, alpha } from '@mui/material/styles';
import Typography from '@mui/material/Typography';
import type { VulnerabilityFoundEvent, VulnerabilitySeverity } from '@promptfoo/types';

interface VulnerabilityCardProps {
  vulnerability: VulnerabilityFoundEvent;
  isNew?: boolean;
}

interface SeverityStyle {
  color: string;
  bgColor: string;
  icon: React.ReactNode;
}

function useSeverityStyle(severity: VulnerabilitySeverity): SeverityStyle {
  const theme = useTheme();

  const styles: Record<VulnerabilitySeverity, SeverityStyle> = {
    critical: {
      color: theme.palette.error.main,
      bgColor: alpha(theme.palette.error.main, 0.08),
      icon: <ErrorIcon sx={{ fontSize: 18 }} />,
    },
    high: {
      color: theme.palette.warning.dark,
      bgColor: alpha(theme.palette.warning.dark, 0.08),
      icon: <ReportProblemIcon sx={{ fontSize: 18 }} />,
    },
    medium: {
      color: theme.palette.warning.main,
      bgColor: alpha(theme.palette.warning.main, 0.08),
      icon: <WarningIcon sx={{ fontSize: 18 }} />,
    },
    low: {
      color: theme.palette.info.main,
      bgColor: alpha(theme.palette.info.main, 0.08),
      icon: <InfoIcon sx={{ fontSize: 18 }} />,
    },
  };

  return styles[severity];
}

function formatTimestamp(timestamp: number): string {
  const date = new Date(timestamp);
  return date.toLocaleTimeString(undefined, {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
  });
}

/**
 * Displays a single vulnerability as a compact, expandable card.
 * Shows plugin name, severity, and expandable details with prompt/output.
 */
export default function VulnerabilityCard({
  vulnerability,
  isNew = false,
}: VulnerabilityCardProps) {
  const [expanded, setExpanded] = useState(false);
  const theme = useTheme();
  const severityStyle = useSeverityStyle(vulnerability.severity);

  return (
    <Card
      elevation={0}
      sx={{
        mb: 1,
        border: `1px solid ${alpha(severityStyle.color, 0.3)}`,
        borderLeft: `4px solid ${severityStyle.color}`,
        backgroundColor: severityStyle.bgColor,
        transition: 'all 0.3s ease',
        // Fade-in animation for new cards
        ...(isNew && {
          animation: 'fadeSlideIn 0.4s ease-out',
          '@keyframes fadeSlideIn': {
            '0%': { opacity: 0, transform: 'translateY(-10px)' },
            '100%': { opacity: 1, transform: 'translateY(0)' },
          },
        }),
      }}
    >
      <Box
        sx={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          px: 2,
          py: 1,
          cursor: 'pointer',
        }}
        onClick={() => setExpanded(!expanded)}
      >
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, flex: 1, minWidth: 0 }}>
          <Box sx={{ color: severityStyle.color, display: 'flex', alignItems: 'center' }}>
            {severityStyle.icon}
          </Box>
          <Typography
            variant="body2"
            fontWeight={600}
            sx={{
              color: severityStyle.color,
              overflow: 'hidden',
              textOverflow: 'ellipsis',
              whiteSpace: 'nowrap',
            }}
          >
            {vulnerability.pluginName}
          </Typography>
          {vulnerability.strategyName && (
            <Chip
              label={vulnerability.strategyName}
              size="small"
              sx={{
                height: 20,
                fontSize: '0.7rem',
                backgroundColor: alpha(theme.palette.text.primary, 0.08),
              }}
            />
          )}
        </Box>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <Typography variant="caption" color="text.secondary">
            {formatTimestamp(vulnerability.timestamp)}
          </Typography>
          <IconButton size="small" sx={{ p: 0.5 }}>
            {expanded ? <ExpandLessIcon fontSize="small" /> : <ExpandMoreIcon fontSize="small" />}
          </IconButton>
        </Box>
      </Box>

      <Collapse in={expanded}>
        <CardContent sx={{ pt: 0, pb: 2 }}>
          <Box sx={{ mb: 2 }}>
            <Typography variant="caption" fontWeight={600} color="text.secondary" sx={{ mb: 0.5 }}>
              Attack Prompt
            </Typography>
            <Box
              sx={{
                p: 1.5,
                borderRadius: 1,
                backgroundColor: theme.palette.background.paper,
                border: `1px solid ${theme.palette.divider}`,
                maxHeight: 150,
                overflow: 'auto',
              }}
            >
              <Typography
                variant="body2"
                sx={{
                  fontFamily: 'monospace',
                  fontSize: '0.8rem',
                  whiteSpace: 'pre-wrap',
                  wordBreak: 'break-word',
                }}
              >
                {vulnerability.prompt || 'No prompt available'}
              </Typography>
            </Box>
          </Box>

          <Box>
            <Typography variant="caption" fontWeight={600} color="text.secondary" sx={{ mb: 0.5 }}>
              Model Response
            </Typography>
            <Box
              sx={{
                p: 1.5,
                borderRadius: 1,
                backgroundColor: theme.palette.background.paper,
                border: `1px solid ${theme.palette.divider}`,
                maxHeight: 150,
                overflow: 'auto',
              }}
            >
              <Typography
                variant="body2"
                sx={{
                  fontFamily: 'monospace',
                  fontSize: '0.8rem',
                  whiteSpace: 'pre-wrap',
                  wordBreak: 'break-word',
                }}
              >
                {vulnerability.output || 'No output available'}
              </Typography>
            </Box>
          </Box>

          <Box
            sx={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              mt: 1.5,
              pt: 1,
              borderTop: `1px solid ${theme.palette.divider}`,
            }}
          >
            <Typography variant="caption" color="text.secondary">
              Test #{vulnerability.testIndex + 1}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              Score: {(vulnerability.score * 100).toFixed(0)}%
            </Typography>
          </Box>
        </CardContent>
      </Collapse>
    </Card>
  );
}

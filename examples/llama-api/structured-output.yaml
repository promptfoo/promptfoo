# JSON structured output with Llama API
# yaml-language-server: $schema=https://promptfoo.dev/config-schema.json

description: JSON structured output capabilities with Llama API models

providers:
  - id: llamaapi:Llama-4-Maverick-17B-128E-Instruct-FP8
    config:
      temperature: 0.1
      response_format:
        type: json_schema
        json_schema:
          name: product_analysis
          schema:
            type: object
            properties:
              product_name:
                type: string
                description: Name of the product
              category:
                type: string
                description: Product category
              price_range:
                type: string
                enum: ['budget', 'mid-range', 'premium']
              features:
                type: array
                items:
                  type: string
                description: List of key features
              rating:
                type: number
                minimum: 1
                maximum: 5
                description: Overall rating out of 5
              pros:
                type: array
                items:
                  type: string
                description: Advantages of the product
              cons:
                type: array
                items:
                  type: string
                description: Disadvantages of the product
            required: ['product_name', 'category', 'price_range', 'rating']
            additionalProperties: false

  - id: llamaapi:Llama-3.3-70B-Instruct
    config:
      temperature: 0.1
      response_format:
        type: json_schema
        json_schema:
          name: sentiment_analysis
          schema:
            type: object
            properties:
              sentiment:
                type: string
                enum: ['positive', 'negative', 'neutral']
              confidence:
                type: number
                minimum: 0
                maximum: 1
              emotions:
                type: array
                items:
                  type: string
                description: Detected emotions
              key_phrases:
                type: array
                items:
                  type: string
                description: Important phrases that influenced sentiment
            required: ['sentiment', 'confidence']
            additionalProperties: false

prompts:
  - '{{task}}'

tests:
  - vars:
      task: "Analyze this product: 'Apple iPhone 15 Pro - A cutting-edge smartphone with titanium design, advanced camera system, and A17 Pro chip. Priced at $999, it offers excellent performance but battery life could be better.'"
    assert:
      - type: is-json
      - type: javascript
        value: "JSON.parse(output).product_name.toLowerCase().includes('iphone')"
      - type: javascript
        value: "JSON.parse(output).category.toLowerCase().includes('smartphone') || JSON.parse(output).category.toLowerCase().includes('phone')"
      - type: javascript
        value: "['budget', 'mid-range', 'premium'].includes(JSON.parse(output).price_range)"
      - type: javascript
        value: 'JSON.parse(output).rating >= 1 && JSON.parse(output).rating <= 5'

  - vars:
      task: "Perform sentiment analysis on this text: 'I absolutely love this new restaurant! The food is amazing, the service is fantastic, and the atmosphere is perfect for a romantic dinner.'"
    assert:
      - type: is-json
      - type: javascript
        value: "JSON.parse(output).sentiment === 'positive'"
      - type: javascript
        value: 'JSON.parse(output).confidence > 0.7'
      - type: javascript
        value: 'Array.isArray(JSON.parse(output).emotions)'

  - vars:
      task: "Analyze this product: 'Generic USB Cable - Basic charging cable for $5. Works fine but build quality is mediocre and it's not very durable.'"
    assert:
      - type: is-json
      - type: javascript
        value: "JSON.parse(output).price_range === 'budget'"
      - type: javascript
        value: 'JSON.parse(output).rating >= 1 && JSON.parse(output).rating <= 5'

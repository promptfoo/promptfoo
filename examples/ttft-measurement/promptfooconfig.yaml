# yaml-language-server: $schema=https://promptfoo.dev/config-schema.json
# Time to First Token (TTFT) measurement example
# This example demonstrates how to measure TTFT using the HTTP provider with OpenAI's Chat Completions API

description: TTFT measurement with gpt-4o-mini streaming

prompts:
  - 'Write a short story about {{topic}}'
  - 'Explain {{topic}} in detail with examples'

providers:
  - id: https://api.openai.com/v1/chat/completions
    config:
      method: 'POST'
      headers:
        'Content-Type': 'application/json'
        'Authorization': 'Bearer {{env.OPENAI_API_KEY}}'
      body:
        model: 'gpt-4o-mini'
        messages:
          - role: 'user'
            content: '{{prompt}}'
        stream: true # Enable streaming for TTFT measurement
        max_tokens: 150
      transformResponse: |
        (json, text) => {
          // Handle non-streaming JSON response
          if (json && json.choices?.[0]?.message?.content) {
            return json.choices[0].message.content;
          }

          // Parse OpenAI streaming SSE format
          let content = '';
          for (const line of String(text || '').split('\n')) {
            const trimmed = line.trim();
            if (!trimmed.startsWith('data: ')) continue;
            if (trimmed === 'data: [DONE]') break;

            try {
              const data = JSON.parse(trimmed.slice(6));
              if (data.choices?.[0]?.delta?.content) {
                content += data.choices[0].delta.content;
              }
            } catch (e) {
              // Skip malformed JSON
            }
          }
          return content.trim();
        }

defaultTest:
  assert:
    # Test that we get meaningful content
    - type: javascript
      value: 'output && output.length > 10'

    # Test TTFT is under 2 seconds
    - type: ttft
      threshold: 2000

    # Test total latency is under 10 seconds
    - type: latency
      threshold: 10000

tests:
  - vars:
      topic: 'artificial intelligence'
  - vars:
      topic: 'climate change'
  - vars:
      topic: 'space exploration'

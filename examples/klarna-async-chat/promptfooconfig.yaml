# Klarna Async Chat API Example
# This demonstrates the responseRequest feature for async APIs
#
# Usage:
#   npm run local -- eval -c examples/klarna-async-chat/promptfooconfig.yaml --env-file .env --no-cache
#
# Required environment variables:
#   KLARNA_AUTH_TOKEN - Bearer token for Klarna API
#   KLARNA_ROOM_ID - Chat room ID to use

description: 'Klarna Async Chat API Test'

providers:
  - id: http
    label: 'Klarna Customer Service Chat'
    config:
      # Step 1: Send message to the chat room
      url: 'https://api.klarna.com/api/support_chat/v10/rooms/{{room_id}}/messages'
      method: POST
      headers:
        Authorization: 'Bearer {{auth_token}}'
        Content-Type: 'application/json'
      body:
        type: 'text'
        content:
          text: '{{prompt}}'

      # Step 2: Poll the room endpoint for the assistant's response
      responseRequest:
        url: 'https://api.klarna.com/api/support_chat/v10/rooms/{{room_id}}'
        method: GET
        headers:
          Authorization: 'Bearer {{auth_token}}'
        polling:
          maxAttempts: 20
          intervalMs: 2000
          timeoutMs: 60000
          # Wait until we see an assistant message
          readyCondition: 'json.messages?.some(m => m.sender_type === "ASSISTANT")'
        # Extract the latest assistant message
        transformResponse: |
          (json) => {
            const messages = json.messages || [];
            const assistantMsg = messages.find(m => m.sender_type === "ASSISTANT");
            return assistantMsg?.message_text || assistantMsg?.content?.text || "";
          }

prompts:
  - '{{message}}'

tests:
  - vars:
      message: 'Hello, I need help with my order'
      room_id: '{{env.KLARNA_ROOM_ID}}'
      auth_token: '{{env.KLARNA_AUTH_TOKEN}}'

  - vars:
      message: 'What is your return policy?'
      room_id: '{{env.KLARNA_ROOM_ID}}'
      auth_token: '{{env.KLARNA_AUTH_TOKEN}}'

  - vars:
      message: 'How do I track my package?'
      room_id: '{{env.KLARNA_ROOM_ID}}'
      auth_token: '{{env.KLARNA_AUTH_TOKEN}}'
